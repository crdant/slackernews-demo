name: branding

on:
  workflow_dispatch:
    inputs:
      slug:
        description: Replicated App Slug
        required: true
        type: string
      api-token:
        description: Replicated API Token
        required: false
        type: string
      api-origin:
        description: Replicated API Origin
        required: false
        default: https://api.replicated.com/vendor
        type: string

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      app-id: ${{ steps.app-id.outputs.app-id }}
    steps:
      - name: Install Replicated CLI
        run: |
          curl -sSL https://raw.githubusercontent.com/replicatedhq/replicated/master/install.sh \
            | sudo bash

      - name: Fetch the application ID from the slug
        id: app-id
        run: |
          app_id=$(replicated app ls --output json | jq -r --arg slug "${{ inputs.slug }}" '.[] | select ( .app.slug == $slug ) | .app.id')
          echo "app-id=${app_id}" >> $GITHUB_OUTPUT
        env:
          REPLICATED_API_TOKEN: ${{ inputs.api-token || secrets.REPLICATED_API_TOKEN }}
          REPLICATED_API_ORIGIN: ${{ inputs.api-origin || 'https://api.replicated.com/vendor' }}

  portal:
    runs-on: ubuntu-22.04
    needs: 
      - prepare
    steps:
      - name: Install Replicated CLI
        run: |
          curl -sSL https://raw.githubusercontent.com/replicatedhq/replicated/master/install.sh \
            | sudo bash

      - name: Checkout branding
        uses: actions/checkout@v4
      
      - name: Setup yq
        uses: mikefarah/yq@master
      
      - name: Prepare branding
        run: |
          # Create a temporary file to work with
          cp branding/enterprise-portal/branding.yaml branding/enterprise-portal-temp.yaml
          
          # Function to convert URL or file path to data URL
          convert_to_data_url() {
            local field=$1
            local value=$(yq eval ".branding.$field" branding/enterprise-portal-temp.yaml)
            
            # Check if it's already a data URL or empty
            if [[ "$value" == "data:"* ]] || [[ "$value" == '""' ]] || [[ "$value" == "null" ]]; then
              return
            fi
            
            local source_file=""
            
            # Check if it's an HTTP/HTTPS URL
            if [[ "$value" == "http"* ]]; then
              # Download the file
              source_file=$(mktemp)
              if ! curl -L -s -o "$source_file" "$value"; then
                echo "Failed to download $field from $value"
                rm -f "$source_file"
                exit 1
              fi
            elif [[ -f "branding/enterprise-portal/$value" ]]; then
              # It's a local file path relative to the branding.yaml location
              source_file="branding/enterprise-portal/$value"
            elif [[ -f "$value" ]]; then
              source_file="$value"
            else
              return
            fi
            
            # Process the file (whether downloaded or local)
            if [[ -f "$source_file" ]]; then
              # Detect content type
              content_type=$(file --mime-type -b "$source_file")
              
              # Convert to base64 and create data URL
              base64_data=$(base64 -w 0 "$source_file")
              data_url="data:$content_type;base64,$base64_data"
              
              # Update the YAML file
              yq eval ".branding.$field = \"$data_url\"" -i branding/enterprise-portal-temp.yaml
              
              # Clean up downloaded file (but not local files)
              if [[ "$value" == "http"* ]]; then
                rm -f "$source_file"
              fi
            else
              echo "File not found for $field: $source_file"
              exit 1
            fi
          }
          
          # Convert logo and favicon if they are URLs or local files
          convert_to_data_url "logo"
          convert_to_data_url "favicon"
          
          # Convert the branding YAML to JSON format expected by API
          yq eval '{"branding": (.branding | @json | @base64)}' branding/enterprise-portal-temp.yaml -o json > branding/enterprise-portal-processed.json

      - name: Setup the Enterprise Portal branding
        run: |
          replicated api put /v3/app/${APP_ID}/enterprise-portal/branding \
            --body "$(cat branding/enterprise-portal-processed.json)"
        env:
          APP_ID: ${{ needs.prepare.outputs.app-id }}
          REPLICATED_API_TOKEN: ${{ inputs.api-token || secrets.REPLICATED_API_TOKEN }}
          REPLICATED_API_ORIGIN: ${{ inputs.api-origin || 'https://api.replicated.com/vendor' }}

  documentation:
    runs-on: ubuntu-22.04
    needs: 
      - prepare
    steps:
      - name: Checkout branding
        uses: actions/checkout@v4
        
      - name: Prepare documentation
        run: |
          # Process documentation separately if it exists
          if [[ -f "branding/enterprise-portal/documentation.yaml" ]]; then
            echo "Processing documentation configuration..."
            
            # Function to process URL fields (should remain as URLs)
            process_url_field() {
              local field=$1
              local value=$(yq eval ".documentation.$field" branding/enterprise-portal/documentation.yaml)
              
              if [[ "$value" == "null" ]] || [[ "$value" == '""' ]]; then
                echo "null"
              else
                echo "\"$value\""
              fi
            }
            
            # Function to process content fields (can be file references or inline content)
            process_content_field() {
              local field=$1
              local value=$(yq eval ".documentation.$field" branding/enterprise-portal/documentation.yaml)
              
              # Skip if field doesn't exist or is empty
              if [[ "$value" == "null" ]] || [[ "$value" == '""' ]]; then
                echo "null"
                return
              fi
              
              # Check if it's a file reference
              if [[ -f "branding/enterprise-portal/$value" ]]; then
                echo "Reading markdown content for $field from $value"
                cat "branding/enterprise-portal/$value" | jq -Rs .
              else
                # Treat as inline content
                echo "$value" | jq -Rs .
              fi
            }
            
            # Build documentation JSON directly
            jq -n \
                --arg helmInstallUrl "$(process_url_field "helm_install_url")" \
                --arg valuesOverrideUrl "$(process_url_field "values_override_url")" \
                --arg embeddedClusterInstallUrl "$(process_url_field "embedded_cluster_install_url")" \
                --arg kurlInstallUrl "$(process_url_field "kurl_install_url")" \
                --arg kotsInstallUrl "$(process_url_field "kots_install_url")" \
                --arg helmPreInstall "$(process_content_field "helm_pre_install")" \
                --arg helmPostInstall "$(process_content_field "helm_post_install")" \
                --arg embeddedClusterPreInstall "$(process_content_field "embedded_cluster_pre_install")" \
                --arg embeddedClusterPostInstall "$(process_content_field "embedded_cluster_post_install")" \
                '{
                  helmInstallUrl: $helmInstallUrl,
                  valuesOverrideUrl: $valuesOverrideUrl,
                  embeddedClusterInstallUrl: $embeddedClusterInstallUrl,
                  kurlInstallUrl: $kurlInstallUrl,
                  kotsInstallUrl: $kotsInstallUrl,
                  helmPreInstall: $helmPreInstall,
                  helmPostInstall: $helmPostInstall,
                  embeddedClusterPreInstall: $embeddedClusterPreInstall,
                  embeddedClusterPostInstall: $embeddedClusterPostInstall
                }' \
              > branding/enterprise-portal-docs.json  
          fi
          
          # Clean up temp file
          rm -f branding/enterprise-portal-temp.yaml

      - name: Setup the Enterprise Portal documentation
        if: hashFiles('branding/enterprise-portal/documentation.yaml') != ''
        run: |
          replicated api put /v3/app/${APP_ID}/enterprise-portal/documentation \
            --body "$(cat branding/enterprise-portal-docs.json)"
        env:
          APP_ID: ${{ needs.prepare.outputs.app-id }}
          REPLICATED_API_TOKEN: ${{ inputs.api-token || secrets.REPLICATED_API_TOKEN }}
          REPLICATED_API_ORIGIN: ${{ inputs.api-origin || 'https://api.replicated.com/vendor' }}


  email:
    runs-on: ubuntu-22.04
    needs: 
      - prepare
    steps:
      - name: Checkout branding
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'branding/email-templates/package-lock.json'

      - name: Build email templates from MJML sources
        run: |
          cd branding/email-templates
          npm ci
          npm run build

      - name: Setup the Enterprise Portal email templates
        run: |
          curl -X PUT \
            -H "Authorization: ${REPLICATED_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @branding/email-templates.json \
            "${REPLICATED_API_ORIGIN}/v3/app/${APP_ID}/enterprise-portal/email-templates"
        env:
          APP_ID: ${{ needs.prepare.outputs.app-id }}
          REPLICATED_API_TOKEN: ${{ inputs.api-token || secrets.REPLICATED_API_TOKEN }}
          REPLICATED_API_ORIGIN: ${{ inputs.api-origin || 'https://api.replicated.com/vendor' }}
